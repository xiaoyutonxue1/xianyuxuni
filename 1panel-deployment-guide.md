# 1Panel平台部署指南（小白友好版）

## 整体思路

### 1. 项目组成部分
一个完整的web项目通常包含以下部分：
- 前端：用户看到的界面
- 后端：处理业务逻辑的服务
- 数据库：存储数据
- 服务器：运行整个系统

### 2. 部署流程图
```
[准备工作] -> [安装1Panel] -> [配置环境] -> [部署应用]
    |              |             |              |
    v              v             v              v
  域名           远程管理     数据库         前端部署
  服务器         面板访问     Node.js       后端部署
  备案                       Nginx         上线测试
```

### 3. 开发到部署的完整流程
1. 开发阶段
   - 前端开发（已完成）
   - 数据库设计（待完成）
   - 后端开发（待完成）
   - 本地测试（待完成）

2. 部署阶段
   - 服务器准备
   - 环境搭建
   - 应用部署
   - 上线测试

3. 维护阶段
   - 运行监控
   - 数据备份
   - 定期更新
   - 问题处理

## 一、准备工作

### 1. 服务器准备
- 购买一台云服务器（建议阿里云/腾���云）
  * 为什么选这些平台：稳定性好，服务支持全面
  * 新手建议：先买1核2G的试用，熟悉后再升级
  
- 最低配置：2核4G内存
  * 为什么要这个配置：运行Node.js和数据库需要足够内存
  * 推荐配置：4核8G（生产环境）
  
- 系统选择：建议Ubuntu 20.04
  * 为什么选Ubuntu：对新手友好，命令简单
  * 版本选择：20.04是长期支持版，稳定性好
  
- 确保有公网IP
  * 作用：让用户能够访问你的网站
  * 注意：需要是固定IP，不要用动态IP
  
- 安全组开放以下端口：
  * 22端口（SSH远程连接用）
  * 80端口（HTTP网站访问用）
  * 443端口（HTTPS加密访问用）
  * 注意：只开放必要的端口，其他都关闭

### 2. 域名准备
- 购买一个域名（阿里云/腾讯云）
  * 新手建议：先买便宜的域名测试使用
  * 注意：.com/.cn等常见域名即可
  
- 完成域名备案（必须，否则无法使用80/443端口）
  * 为什么要备案：国内法律要求，否则网站可能被关闭
  * 备案流程：一般需要2-7天，跟着平台引导操作即可
  
- 添加域名解析：
  * 记录类型：选择A记录
  * 主机记录：@（根域名）或www
  * 记录值：你的服务器公网IP
  * 注意：解析生效需要等待几分钟到几小时

### 3. 开发环境准备（本地电脑）
- 安装Node.js
- 安装开发工具（VSCode等）
- 准备好前端代码
- 准备好后端代码（如果有）

## 二、安装1Panel

### 1. 为什么选择1Panel
- 一站式管理：所有服务都在一个界面管理
- 可视化操作：不需要记忆复杂的命令
- 应用商店：一键安装各种服务
- 安全可靠：自动配置安全策略

### 2. 连接服务器
```bash
# 使用SSH连接服务器
ssh root@你的服务器IP
```
- 注意事项：
  * 首次连接会提示确认，输入yes
  * 密码输入时是看不见的，正常输入即可
  * 如果连接失败，检查IP和密码是否正确

### 3. 安装1Panel
```bash
# 一键安装命令
curl -sSL https://resource.fit2cloud.com/1panel/package/quick_start.sh -o quick_start.sh && sudo bash quick_start.sh
```
- 安装过程说明：
  * 整个过程约需5-10分钟
  * 安装完成会显示访问地址和密码
  * 建议立即保存这些信息

### 4. 安装完成后记录信息
- 1Panel访问地址（形如：http://IP:端口）
- 用户名（默认是admin）
- 密码（系统自动生成的）

## 三、基础环境配置

### 1. 登录1Panel
- 打开浏览器访问安装完成后提供的地址
- 输入用户名和密码登录
- 首次登录后修改密码（重要）
- 注意事项：
  * 使用现代浏览器（Chrome/Firefox等）
  * 如果无法访问，检查防火墙设置

### 2. 安装必要的应用
通过1Panel应用商店安装：

1. PostgreSQL数据库
   - 为什么选PostgreSQL：
     * 功能强大，性能好
     * 适合开发各类应用
   - 安装步骤：
     * 点击"应用商店" -> 搜索"PostgreSQL"
     * 选择版本：14.x（稳定版）
     * 设置端口：5432（默认）
     * 设置root密码（请记录下来）
     * 选择安装位置（建议默认）

2. Node.js环境
   - 为什么需要：
     * 运行后端服务必需
     * 前端构建工具需要
   - 安装步骤：
     * 点击"应用商店" -> 搜索"Node.js"
     * 选择版本：18.x（稳定版）
     * 按默认配置安装

3. Nginx服务器
   - 作用说明：
     * 提供网站访问服务
     * 反向代理后端服务
     * 处理SSL证书
   - 安装步骤：
     * 点击"应用商店" -> 搜索"Nginx"
     * 选择最新稳定版
     * 按默认配置安装

## 四、开发和部署流程

### 1. 数据库部署
- 目标：准备好存储数据的环境
- 详细步骤：

  1. 创建数据库
     * 进入1Panel PostgreSQL管理页面
     * 点击"创建数据库"按钮
     * 填写数据库名：virtual_goods
     * 设置字符集：UTF-8
     * 选择排序规则：C.UTF-8（推荐）

  2. 创建数据库用户
     * 点击"创建用户"按钮
     * 用户名：app_user（建议）
     * 设置强密码并记录
     * 授权范围：仅本地访问

  3. 设置访问权限
     * 进入用户管理页面
     * 为app_user授予数据库权限
     * 建议仅授予必要权限：
       - SELECT, INSERT, UPDATE, DELETE
       - CREATE, ALTER（开发阶段需要）

  4. 配置远程访问（如需要）
     * 修改postgresql.conf
     * 配置listen_addresses
     * 修改pg_hba.conf
     * 注意：建议只允许特定IP访问

  5. 测试连接
     * 使用psql命令行工具测试
     * 使用图形化工具（如DBeaver）测试
     * 检查是否能正常执行SQL

### 2. 后端开发
- 目标：实现业务逻辑和API接口
- 技术选型：
  * 框架：Express.js + TypeScript
  * ORM：TypeORM（操作数据库）
  * 认证：JWT（处理登录状态）
  * 日志：Winston（日志记录）

- 详细步骤：
  1. 搭建项目框架
     * 创建项目目录结构
     * 初始化package.json
     * 配置TypeScript
     * 设置开发环境

  2. 配置开发环境
     * 安装依赖包
     * 设置环境变量
     * 配置开发工具
     * 设置调试配置

  3. 实现基础功能
     * 用户认证模块
       - 注册接口
       - 登录接口
       - JWT中间件
     * 数据库连接
       - 配置TypeORM
       - 创建实体类
       - 编写迁移文件
     * 错误处理
       - 全局错误处理
       - 日志记录
       - 错误响应格式

  4. 开发业务接口
     * 用户管理
       - CRUD操作
       - 权限控制
     * 商品管理
       - 商品CRUD
       - 库存管理
     * 订单管理
       - 创建订单
       - 订单状态流转
       - 支付集成

  5. 编写测试用例
     * 单元测试
     * 集成测试
     * API测试
     * 性能测试

  6. 准备部署文件
     * 编写Dockerfile
     * 创建docker-compose.yml
     * 准备环境配置文件
     * 编写部署脚本

### 3. 前端部署
- 目标：部署用户界面
- 详细步骤：

  1. 准备部署环境
     * 确认Node.js版本
     * 检查npm配置
     * 准备构建环境
     * 检查依赖完整性

  2. 构建生产版本
     * 修改环境变量
       - 设置API地址
       - 配置其他参数
     * 执行构建命令
       ```bash
       npm run build:prod
       ```
     * 检查构建产物
       - dist目录完整性
       - 静态资源是否完整
       - 入口文件是否正确

  3. 上传到服务器
     * 使用1Panel文件管理器
       - 创建目录
       - 上传文件
       - 设置权限
     * 或使用其他方式
       - SCP命令上传
       - FTP工具上传
       - Git部署

  4. 配置Nginx
     * 基础配置
       - 域名设置
       - SSL证书
       - 静态文件缓存
     * 高级配置
       - Gzip压缩
       - 浏览器缓存
       - 安全头部
     * 性能优化
       - 开启压缩
       - 配置缓存
       - 启用HTTP2

  5. 测试验证
     * 访问测试
       - HTTPS是否正常
       - 页面是否完整
     * 功能测试
       - 路由是否正常
       - API是否可访问
     * 性能测试
       - 加载速度
       - 资源响应

### 4. 后端部署
- 目标：部署服务端程序
- 详细步骤：

  1. 准备部署环境
     * 检查Node.js环境
     * 安装必要工具
     * 配置环境变量
     * 准备部署目录

  2. 上传代码
     * 使用1Panel文件管理器
       - 创建部署目录
       - 上传源代码
       - 设置权限
     * 配置Git（可选）
       - 设置部署密钥
       - 配置自动部署
       - 设置钩子脚本

  3. 安装依赖
     * 执行npm install
     * 检查依赖完整性
     * 处理版本冲突
     * 优化node_modules

  4. 配置环境
     * 创建.env文件
     * 设置生产环境变量
     * 配置数据库连接
     * 设置日志级别

  5. 启动服务
     * 使用PM2管理
       - 配置启动文件
       - 设置实例数量
       - 配置日志轮转
       - 设置自动重启
     * 监控和告警
       - 配置资源监控
       - 设置错误告警
       - 配置性能监控

### 5. 监控和维护
- 目标：确保系统稳定运行
- 详细步骤：

  1. 系统监控
     * 服务器监控
       - CPU使用率
       - 内存占用
       - 磁盘空间
     * 应用监控
       - 接口响应时间
       - 错误率统计
       - 并发数监控

  2. 日志管理
     * 日志收集
       - 应用日志
       - 访问日志
       - 错误日志
     * 日志分析
       - 错误排查
       - 性能分析
       - 用户行为分析

  3. 备份策略
     * 数据库备份
       - 定时备份
       - 备份验证
       - 恢复演练
     * 文件备份
       - 代码备份
       - 配置备份
       - 媒体文件备份

  4. 应急预案
     * 服务器故障
       - 备用服务器
       - 快速恢复流程
     * 应用故障
       - 版本回滚
       - 紧急修复流程
     * 数据问题
       - 数据恢复
       - 数据修复方案

## 五、具体部署步骤

### 1. 上传前端代码
1. 在本地构建
   ```bash
   # 本地电脑上执行
   cd frontend
   npm install
   npm run build:prod
   ```

2. 上传构建文件
   - 在1Panel中进入"文件管理"
   - 创建目录：/var/www/virtual-goods
   - 上传dist目录下的所有文件

### 2. 配置Nginx站点
1. 创建网站
   - 点击"网站" -> "添加网站"
   - 选择"静态网站"
   - 填写信息：
     * 域名：你的域名
     * 网站目录：/var/www/virtual-goods
     * 运行用户：www-data

2. 配置SSL证书
   - 点击网站的"证书"按钮
   - 选择"申请证书"
   - 选择"Let's Encrypt"
   - 按向导完成申请

3. 修改Nginx配置
   - 点击网站的"配置文件"
   - 将以下内容粘贴进去：
   ```nginx
   server {
       listen 80;
       server_name your_domain.com;
       return 301 https://$server_name$request_uri;
   }

   server {
       listen 443 ssl http2;
       server_name your_domain.com;

       # SSL配置（证书路径会自动配置）

       root /var/www/virtual-goods;
       index index.html;

       # 前端路由支持
       location / {
           try_files $uri $uri/ /index.html;
           expires 7d;
       }

       # API代理
       location /api {
           proxy_pass http://localhost:3000;
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection 'upgrade';
           proxy_set_header Host $host;
           proxy_cache_bypass $http_upgrade;
       }
   }
   ```

### 3. 上传后端代码
1. 创建目录
   ```bash
   mkdir -p /var/www/virtual-goods-api
   ```

2. 上传代码
   - 使用1Panel的文件管理器上传后端代码

### 4. 配置环境
1. 创建环境配置文件
   - 在1Panel文件管理器中创建：/var/www/virtual-goods-api/.env
   ```
   NODE_ENV=production
   PORT=3000
   DB_HOST=localhost
   DB_PORT=5432
   DB_NAME=virtual_goods
   DB_USER=app_user
   DB_PASSWORD=你的数据库密码
   JWT_SECRET=生成一个随机字符串
   ```

### 5. 安装依赖并启动
1. 打开1Panel终端
2. 执行以下命令：
   ```bash
   cd /var/www/virtual-goods-api
   npm install
   npm run build
   
   # 安装PM2
   npm install -g pm2
   
   # 启动服务
   pm2 start dist/main.js --name virtual-goods-api
   pm2 save
   pm2 startup
   ```

## 六、检查和验证

### 1. 检查服务状态
1. 检查数据库
   - 1Panel -> 数据库 -> PostgreSQL
   - 确认状态为"运行中"

2. 检查网站
   - 1Panel -> 网站
   - 确认状态为"运行中"

3. 检查后端服务
   ```bash
   pm2 status
   ```

### 2. 访问测试
1. 浏览器访问你的域名
2. 检查前端页面是否正常加载
3. 测试登录等功能
4. 检查API是否正常响应

## 七、常见问题

### 1. 网站无法访问
- 检查域名解析是否生效
- 检查安全组80/443端口是否开放
- 检查Nginx配置是否正确
- 查看Nginx错误日志

### 2. API请求失败
- 检查后端服务是否运行
- 检查数据库连接是否正常
- 查看后端日志：`pm2 logs`

### 3. 数据库连接失败
- 检查数据库服务是否运行
- 验证数据库用户名密码
- 检查数据库权限配置

### 4. SSL证书问题
- 确保域名已备案
- 检查DNS解析是否正确
- 重新申请证书

## 八、维护建议

### 1. 定期检查
- 每天查看运行状态
- 检查日志是否有异常
- 监控服务器资源使用情况

### 2. 更新维护
- 定期更新系统安全补丁
- 更新SSL证书（自动）
- 定期清理日志和临时文件 

## 下一步开发计划

1. 数据库开发
   - 设计数据表结构
   - 创建必要的索引
   - 准备初始数据

2. 后端开发
   - 搭建项目框架
   - 实现用户认证
   - 开发业务接口
   - 对接数据库

3. 功能测试
   - 接口测试
   - 性能测试
   - 安全测试

4. 部署上线
   - 部署到���试环境
   - 验证所有功能
   - 正式环境部署
   - 监控运行状态 